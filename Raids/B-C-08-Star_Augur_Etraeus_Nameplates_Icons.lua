--- WeakAura Strings ---
dCf6zaqEfW6LI07bL08bfr3huI9JgqqsYIuOhbkcBciPYNaskgfeDki8kGKsZsa3cuyxGQHrqDmLsldQ0ZukmnOcxtPOTjfX3eIQXPaPfVarwNusVdQ6Ecv7tik1bvIYcbL6HcHjkKYfvISrf0hbcJubcNuizLe6LGI0mbf1nLIANsP(jqQHkL4OcrjlLG0tLQPQuDQfiQTQa1xbscpmiPQZeKeTwHu1BjiMRquCxOI2Ri)LadM6WQSyHipgetwjDzsBgK(Sqz0kHtlQvdKK61ajMnKUTG2TQ(TIgUaDvGOLt0ZHY0LCDaBhO(UsunEPW5esLtBt7PEyQVM6RP9uhYeDkt7P2Btdh0ip62e3MS52nXrtWn6WXgdAckm2CJuL6RzSGO3a7AJk1tDiay1mCxBuPofPift9dsLbR7YCSyQS55QMAlCQFqQ88Xs7PowDYkTN6RtbqaWQzyc2PoeaSAgM6hG8eOpy4kyvoWq5fQirGpvPE(ZvAp1xNcGaGvZWeStDiay1mm1rNqou6mK53ZnvPJtdRnr4a0nryybpfpa5jqFWW)ludIELgfK5JrhNgwPinnnTqgbHu1FeN0XPXDJMSz0TzakstttlKrHQRJ4KoonUB0KMSfxkcl4P4bipb6dgowo2J1dQOOy0XPHvkstttleKWki0QhurrJ6HorIRWBIdCJoeWccHSfN4Koo942XauKMMMwiiHvqOvpOIIg1dDIexH3eh4yteWccHSfN4Koo9iUJbOinnnTqqcRGqREqffnQh6ejUBBYg4yteWccHSfN4Koo94gJbOinnnTqqcRGqREqffnQh6ejUBBYg4ahiGfeczloXjDC6rCmsrybpfP4bipb6dgoKfkeqP9fQbrVs7Av5pggDCAOapKkpFKiOinnnnmGb9WPeIs)xOge9kfJgtRk)XWOinnnn6eYHs3C0VthNgeA1C(ZHxWOF(6U2OqIapfPPPPZqPBo63PJhNECPsL)Hsd6iHPsWxnLdmspL0nh970XJtpc6iHPsWxnZsLgu)GCPYxrhPRf6ttrAAAAAAA6mu6Fw0hG8eOpy4yhyDLUwOpfPPPPPPPPPPPPpa5jqFWW)ludIEL28SYZVFGv640GqRig8jro(xOge9kT5zLN)ic8uKMMMMMMMMMMM(aKNa9bd)Vqni6vAFXC5dLz9xX6hyLooni0kIbFsKJ)fQbrVs7lMlFOmR)k2ic8uKMMMMMMMMMMM(aKNa9bd)Vqni6vAZxJOLXQ7HO0XPbHwrm4tIC8Vqni6vAZxJOLXQ7HOJiWtrAAAAAAAAAAA6Uwrm4tIC8Vqni6vAZZkp)Xa0BrGNI000000000000DTIyWNe54FHAq0R0(I5YhkZ6VIngGElc8uKMMMMMMMMMMMURved(Kih)ludIEL281iAzS6Ei6ya6Tclmc8uKMMMMMMMMMMM(aKNa9bdh7aRR0XPljGINI000000006VsrAAAAyadAHQy1uQ0tzow(puAmTQ8hdJI0000kkMsrAAAAAAA6mu6dqEc0hmCSdSUsxl0NI000000000000DTIyWNe54FHAq0R0MNvE(JbOpa5jqFWW)ludIEL28SYZVFGv6PKElc8uKMMMMMMMMMMMURved(Kih)ludIEL2xmx(qzw)vSXa0hG8eOpy4)fQbrVs7lMlFOmR)kw)aR0tjTWiWtrAAAAAAAAAAA6Uwrm4tIC8Vqni6vAZxJOLXQ7HOJbOpa5jqFWW)ludIEL281iAzS6Eik9usVvyHrGNI000000000000hG8eOpy4)fQbrVsBEw553pWkDC6pJINI000000000000hG8eOpy4)fQbrVs7lMlFOmR)kw)aR0XP)mkEkstttttttttttFaYtG(GH)xOge9kT5Rr0Yy19qu640FgfpfPPPPPPPPPPPPpa5jqFWWXoW6kDC6pJINI000000006VstrAAAA9xPO(RuKIhG8eOpy4L2OaKAlZjkDCAyfwWtXdqEc0hm8sBuasnQFvBqhNwy8uKIhG8eOpy4X0AxBuasDOCg2YCIshNgkWdPYZhjckstttFaYtG(GHxAJcqQr9RAd640hG8eOpy4L2OaKAu)Q2Ggul9w8uKMMModL(aKNa9bdV0gfGuJ6x1g0r20WehG8eOpy4L2OaKAlZjkDTqFkstttttttJoHCO0qLxOshNocPELouEHkYXHYluhrGNI00000000qLxO2AxRHYlu7L8Qd5iSxweWuqiuqdY2rBebEkstttttttdvEHARDTgkVqfMvWkksHrGNI00000000qLxO2AxREUPkYmK53ZnvfYwCgGodz(9CtvHGlorGNI00000000qLxO2AxRwM5VqogXsT3xsOJbOfoaTWiWtrAAAAAAAAOYluBDqKxvKiWtrkstttttttdvEHk8mK5thNgQ8c1wJqQxP7AJcqQi)mAa6ryVSiGPGqOGgKTJ2ya6pJgGggdkc8uKMMMMMMMgQ8cv4ziZV1UwldfTLz(lmKiWtrAAAAAAAAOYluHNHm)w7AnyvwAJiMOtjYTbO3gGEBa6TiWtrkstttttttdvEHkCSsM)y4shNgQ8c1wJqQxPdNF1lz(JH8ZObOhH9YIaMccHcAq2oAJbO)mAaAye5iWtrAAAAAAAAOYluHJvY8hd3w7AnC(fYXHZVWImrMHcnQOpYAxGa477dhdqVfhbOhbni3H5OAV0ic8uKMMMMMMMgQ8cv4yLm)XWT1UwTmZFHCe2GEFh0ndZlnCFmanu5fQbOhHnO33bDZW8sd3hdqlCaAHrGNIuKMMMMMMMgQ8cv4yLm)XOJtdvEHARri1R0HZV6Lm)Xq(z0a0JWEzratbHqbniBhTXa0FgnanmICe4Pinnnnnnnnu5fQWXkz(J1AxRHZVqooC(fwKjYmuOrf9rw7ceaFFF4yaACfoa9iOb5omhv7LgrGNI00000000qLxOchRK5pwRDTAzM)c54oOBbMxA4(yaAOYludqpUd6wG5LgUpgGw4a0cJapfPinnnnnnn9bipb6dgEPnkaP2YCIkKdqEc0hm8sBuasnQFvBGt640qLxOINI00006VsrAAAAPwaYN(aKNa9bdV0gfGuBzorfYbipb6dgEPnkaPg1VQnWjEkQ)kfP4bipb6dg(TUURnkaPUpBFHAq0Ru640qbEivE(ib(CfGodz(bOlTrfGU0gfUiOinnnn6eYHs)xOge9kLooDecAFHAlOxPWbHwTVqTf0R0Htji)CHe4Zfc8uKMMModL(Nf9FHAq0Ru6AH(0sTaKpEA9xPinnnn6eYHsdvEHkDC6dqEc0hm8yATRnkaPouodBzorrIapfPPPPHkVqT1iq1tUmu0wM5VWqIapfPPPPHkVqT1UwTmZFHCmILAVVKqhdq)xOge9kna9yel1EFjHogGw4a0WaxHrGNI0000qLxOcpdz(T21AxBuasfzgY8rGNI0000qLxOchRK5pwRDT21gfYsBuiWtrAAAAOYluHJvY8hd3w7ATRnkKL2OWfbEkstttdvEHAR9fZLJebEkQ)kfP4bipb6dgUcwLdmuEHkDCAOapKkpFKiOinnnn0PKohFBaAyIdqEc0hm8sBuasTL5eLEDsrAAAAAAA6dqEc0hm8sBuasTL5evizC26GiVQirGNI00006VsrAAA6dqEc0hm8sBuasnQFvBqhNwy8uu)vksXdqEc0hm8yA1ZX(Htji)CrhNgkWdPYZhjWNleuKMMMg6usJLJ9bOlTrrNF6GxwIH8aKNa9bdhlh7X6bvuume0RtkstttttttNHsdYpxrtJeauOib(CfGglh7rqxl0NwQfG8PlTrHNw)vAkstttR)kfPPPPLAbiF6pJINI6VMQuL6qNFne9IHL6GgK7WCuTxk1XuuOTmZFL6rSu79LeAQxYCSyQmTN61ab1uhcawndtDiay1muqnqqn1XQRaWsDamvaWNReStDfS(vQhXIROBwXWUyAQdbaRMHPouGhsLNpseuKMMMggWGUfPcw)Iwc80zO0rAIHrNXEqnf9jNa)kfPPPPZqPb5NR2xOICmstmSTJiOjmzC6XEDs6LbedqsVujpfaBKEkPb5NR2xOICmstmSTJiOjmzC6XLk5PaybOrhKavbQ8aIbivASsrrVSuhPRf6tl1cq(4P1FLIuKMMMggWGoIfkeqHU9fQbrVsXO7Av5pggnOoAHQyArpuEHkgfPPPPpa5jqFWWHSqHakTVqni6vAxRk)XWqIapfPPPPpa5jqFWWvWQCGHYlurIapfPinnnnmGbDhY90y5ypgfPPPPrNqou6W8R0XPJPvph7hoLG8ZfYXGO3aQCebEkstttNHshMFLUwOpfPPPPPPPPrNqouAGpxbORfAwIHNI00000000qNs6C8TbObHwTbcbHCceSznmsQedjc61jfPPPPPPPPPPPPb(CrhNEuE51r4WRjwjZFmKze4PinnnnnnnnnnnDgk9plAq(5kkmq(5cjWNRa0JbrVbu5ic6AH(uKMMMMMMMMMMMMMMMUwOzjgDC6dqEc0hm8yA1ZX(Htji)CHe4Zfc8uKMMMMMMMMMMMMMMModLUwOzjgD840H5xPRf6trAAAAAAAAAAAAAAAAAAA6dqEc0hm8BDDxBuasDF2(c1GOxPib(CfG(aKNa9bd)Vqni6vAuqMpgCqiv9dqxl0Selani)C1(cvKaFUqGapfPPPPPPPPPPPPPPPPvumndLUwOzjgDTqFkstttttttttttttttttttFaYtG(GHFRR7AJcqQ7Z2xOge9kfjWNRa0hG8eOpy4)fQbrVsJcY8XGluDnaDTqZsSa0G8Zv7lurc85cbc8uKMMMMMMMMMMMMMMMw)vkstttttttttttR)kfPPPPPPPP1FLI00006Vsttttr9xtDiluiGsQdeC9kn1bEfS(vQFa1m1HaGvZqblYRAQx5qDnvPowLHakdena5v55NIuQVqZXwuPH4ytH3OjBSbo2uyC3iYJUnXnbfgBIBQJoV10EQdGPcEfSktrk1B681uFFHs3ohBrTyIUM6ayQa9Hmb(sL51uKsDamvqtNVMIuQdGPcwZqHMHaGwdKGDQJLBQM2tDS8hdvt9GNSgi1dbqRCAp1dEYAGeStvQs9MoFnQ1uFRWd6GM61HQFL2t9qa0kN2tvQs91muOziaO1aP9uhl)Xq1upCGArgsQhcGw50EQdzXHIQFmnb7uLQuhatfGfurrbLFU8pfPupi4G1HQFL2t9qa0kN2tvQsDOhKkp)0EQhcGw50EQsvQlNOAAp1dbqRCApvPk1LhenTN6HaOvoTNQuL6ayQGMoFnQ1eStvQdD(vp3un1oYXn1xZybrVb61bbuWsD6uxQXYZFFGGAQxAJk1VphEvE(P9up8YFAp1dkvmTs9dn4IRfaumnvPk1ZqMFc2PowDqafSiMFD5pu)k1JQDpQOTuQ305mm1w4u)aQzc2PEEn1bvSmbltRfdGjOxNKEzaXaK0lvYtbWOhkZ6VIoaD7ludIELIL636AUYZ)qfuYCSyQelTNQu)bc3L5yXujwQ92uF551ArAio2u4nAYgBGJnfg3nI8OBtCtqHXM4M6aFjZXIPY0EQdbaRMHPouGhsLNpseuKMMMwQfG8PljGINI6VMQuFvXUcqELMIuQNFWQettrk1xZyGQbEivgSM63pqQVMXcIEdefK5NAVDJMG7gBM6y1bbuWAzM)k1HnO33bDZcnkqmi2t9sBurmrNY0EQ92u7TP24MAVn1EJu7TP24i1EBQsvQJL64cFd4cdx4uhCQ9wCG72uLsa

--[[
Author : Aethys, Serenity
Version : 1.0 (02.13.2017)
Readme :
	WeakAura to mark friendlies nameplates in green or red according to the mark they got.
]]--


--- Actions\On Init\Custom ---

-- Init
local iconSize = {60, 60};
aura_env.nameplateIcons = {
    ["Green"] = 236595,
    ["Red"] = 236612
};
aura_env.signsSpells = {
    [({GetSpellInfo(205429)})[1]] = "1",
    [({GetSpellInfo(205445)})[1]] = "2",
    [({GetSpellInfo(216345)})[1]] = "3",
    [({GetSpellInfo(216344)})[1]] = "4"
};

aura_env.checkNameplateSettings = function()
    -- Force nameplates settings
    local MZT = GetMinimapZoneText();
    if MZT == "Eternal Observatory" or MZT == "Observatoire éternel" then 
        if not aura_env.saved then
            aura_env.nameplateMotionSave = GetCVar("nameplateMotion");
            aura_env.nameplateShowFriendsSave = GetCVar("nameplateShowFriends");
            aura_env.nameplateMaxDistance = GetCVar("nameplateMaxDistance");
            SetCVar("nameplateMotion", 1);
            SetCVar("nameplateShowFriends", 1);
            SetCVar("nameplateMaxDistance", 100);
            aura_env.saved = true;
        end
    -- Restore original settings
    else
        if aura_env.saved then
            SetCVar("nameplateMotion", aura_env.nameplateMotionSave or 1);
            SetCVar("nameplateShowFriends", aura_env.nameplateShowFriendsSave or 0);
            SetCVar("nameplateMaxDistance", aura_env.nameplateMaxDistance or 100);
            aura_env.nameplateMotionSave = nil;
            aura_env.nameplateShowFriendsSave = nil;
            aura_env.nameplateMaxDistance = nil;
            aura_env.saved = nil;
        end 
    end
end

aura_env.texturePool = {};
aura_env.textureIndex = 0;

aura_env.getTextureFromPool = function()
    aura_env.textureIndex = aura_env.textureIndex + 1;
    if aura_env.textureIndex > #aura_env.texturePool then
        local frame = CreateFrame("Frame");
        frame:SetFrameStrata("BACKGROUND");
        frame:SetFrameLevel(0);
        frame:SetSize(iconSize[1], iconSize[2]);
        frame:SetPoint("CENTER", 0, 0);
        frame:Hide();

        frame.icon = frame:CreateTexture(nil, "BACKGROUND", nil, -8);
        frame.icon:SetAllPoints();
        frame.icon:SetVertexColor(1, 1, 1, 1);

        frame.string2 = frame:CreateFontString(nil, "BACKGROUND", nil, -7);
        frame.string2:SetFont("Fonts\\FRIZQT__.TTF", 14, "OUTLINE");
        frame.string2:SetPoint("BOTTOMLEFT", frame, "BOTTOMLEFT", 0, 0);

        frame.string = frame:CreateFontString(nil, "BACKGROUND", nil, -7);
        frame.string:SetFont("Fonts\\FRIZQT__.TTF", 20, "OUTLINE");
        frame.string:SetPoint("TOPLEFT", frame, "TOPLEFT", 0, 0);

        aura_env.texturePool[aura_env.textureIndex] = frame;
    end
    return aura_env.texturePool[aura_env.textureIndex];
end

aura_env.addTextureToNameplate = function(unit, icon, text, text2)
    local nameplate = C_NamePlate.GetNamePlateForUnit(unit);
    if not nameplate then return; end
    local frame = aura_env.getTextureFromPool();
    frame:ClearAllPoints();
    frame:SetPoint("CENTER", nameplate, "CENTER", 0, -20);
    frame.icon:SetTexture(icon);
    frame.string:SetText(text);
    frame.string2:SetText(text2);
    frame:Show();
end

aura_env.everyFrame = function()
    for i=1, #aura_env.texturePool do
        aura_env.texturePool[i]:Hide();
    end
    aura_env.textureIndex = 0;
end

aura_env.getSignForUnit = function(unit)
    for sign, text in pairs(aura_env.signsSpells) do
        if UnitDebuff(unit, sign) then return text; end 
    end
    return nil;
end

-- Show (Custom)
aura_env.everyFrame();


--- Trigger\Custom Trigger ---

-- Trigger [Status\Every Frame]
function()
    -- Prevent run if boss isn't around
    if UnitName("boss1") ~= "Star Augur Etraeus" or UnitName("boss1") ~= "Etraeus, l’augure stellaire" then return; end

    -- Check Nameplates Settings & Reset Frames
    aura_env.checkNameplateSettings();
    aura_env.everyFrame();

    -- Scan signs
    local mine = getSignForUnit("player");
    if mine then
        local unit, theirs;
        for i=1, GetNumGroupMembers() do
            unit = "raid"..tostring(i);
            if not UnitIsUnit(unit, "player") then
                theirs = aura_env.getSignForUnit(unit);
                if theirs == mine then
                    aura_env.addTextureToNameplate(unit, aura_env.nameplateIcons.Green, theirs, UnitName(unit));
                elseif theirs then
                    aura_env.addTextureToNameplate(unit, aura_env.nameplateIcons.Red, theirs, UnitName(unit));
                end
            end
        end
    end    
end

-- Untrigger
function()
    return true;
end
